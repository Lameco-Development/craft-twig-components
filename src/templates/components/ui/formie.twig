{# Theme #}
{% set theme = theme is defined and theme is not empty
  ? theme|json_decode
  : _globals.get('formie.theme')
%}

{# Component Variables #}
{% set form = form ?? null %}

{# Component #}
{% if form is not empty %}
  {{ craft.formie.renderForm(form, theme) }}

  {# prettier-ignore-start #}
  {% js %}
  document.addEventListener("onFormieInit", (event) => {
    let Formie = event.detail.formie;
    let $form = event.detail.$form;
    Formie.refreshForCache(event.detail.formId);

    $form.addEventListener("onAfterFormieValidate", (e) => {
      if (typeof window.dataLayer !== "undefined") {
        if (event.detail.nextPageId) { return; }

        window.dataLayer = window.dataLayer || [];
        dataLayer.push({ "event": "formSubmitted", "formHandle": event.detail.form.config.formHandle });
      }
    });
  });
  {% endjs %}
  {# prettier-ignore-end #}
{% endif %}
